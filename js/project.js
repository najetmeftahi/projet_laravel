

var workingOn=0;function Setlastpjid(){$.ajax({type:"GET",url:"./API/projects.php?maxinc",dataType:"text",success:function(t){$("#lastidval").val(t),$("#lastidval").text(t),$("#Addmember").attr("pid",t)}})}function setmemfields(){$("#Newm_fname").val(""),$("#Newm_lname").val(""),$("#Newm_role").val("ds"),$("#pjtmembersbody").html("")}function setAddpjFields(){parseInt($("#lastidval").val()),$("#pjtitle").val(""),$("#pjgoal").val(""),$("#pjdesc").val(""),setmemfields(),$("#pjtmembersbody").html(""),$("#pjstatus").val("")}function showAddPj(){$(".AddPjPanel").show(),$(".pjlists").hide(),$("#panel-workon").hide()}function closeAddPj(){$(".AddPjPanel").hide(),$(".pjlists").show()}function showWorkOn(){$("#panel-projects").hide(),$("#panel-workon").show()}function CloseWorkOn(){$("#panel-projects").show(),$("#panel-workon").hide()}function showonprojecttab(){$(".off-project").hide(),$(".on-project").show(),$("#taskcategory").html('\n    <option value="onproject" selected>Project Tasks</option>\n    <option value="offproject">Off Project Tasks</option>\n    ')}function showoffprojecttab(){$(".off-project").show(),$(".on-project").hide(),$("#taskcategory").html('\n    <option value="onproject">Project Tasks</option>\n    <option value="offproject" selected>Off Project Tasks</option>\n    ')}function updatemembercount(){$.ajax({type:"GET",url:"./API/projects.php",dataType:"text",success:function(){}})}function lsprojects(){$("#pjtbody").html(""),updatemembercount(),$.ajax({type:"GET",url:"./API/projects.php",dataType:"json",success:function(t){var e={1:"Not Started",2:"On Track",3:"Done"},s={1:"iws-not",2:"iws-ont",3:"iws-don"};$.each(t,(function(t,n){row=`\n                    <tr class="TableprojectRow" pid="${n.id}">\n                        <th class="text-muted">${t+1}</th>\n                        <td>${n.title}</td>\n                        <td><span class="rounded-pill text-light bg-${s[n.pstatus]} px-3 py-1">${e[n.pstatus]}</span></td>\n                        <td>${n.goal}</td>\n                        <td>${n.sdate}</td>\n                        <td>${n.edate}</td>\n                        <td>${n.powner}</td>\n                        <td>${n.member_count}</td>\n                        <td>\n                            <button class="btn btn-sm btn-iws-outline-blue border-0" id="btn-workon-pj" project-id="${n.id}">\n                            <i class="fa-solid fa-list"></i>\n                            </button>\n                            <button class="btn btn-sm btn-outline-secondary border-0" id="btn-edit-pj" onclick="viewpj(${n.id})">\n                                <i class="fa-solid fa-pencil"></i>\n                            </button>\n                            <button class="btn btn-sm btn-iws-outline-red border-0" id="btn-delete-pj" onclick="calldeletepj(${n.id})">\n                                <i class="fa-solid fa-trash-can"></i>\n                            </button>\n                        </td>\n                    </tr>\n                    `,$("#pjtbody").append(row)}))}})}function list_mem_this(t){$("#pjtmembersbody").html(""),$("#pjtmembersbody").html(""),$.ajax({type:"GET",url:"./API/list_mem_this.php?pid="+t,dataType:"json",success:function(t){$.each(t,(function(t,e){1,row=`<tr>\n                            <th scope="row">${e.id}</th> \n                            <td>${e.firstname}</td>\n                            <td>${e.lastname}</td>\n                        </tr>`,$("#pjtmembersbody").append(row)}))}})}function addmember(t,e,s,n){var a="./API/store_m.php?fname="+t+"&lname="+e+"&pid="+n+"&mrole="+s;$.ajax({type:"GET",contentType:"application/json; charset=utf-8",dataType:"text",url:a,success:function(t){list_mem_this(parseInt($("#lastidval").val()))}})}function postaddmember(t,e,s,n){var a="./API/store_m.php?fname="+t+"&lname="+e+"&pid="+n+"&mrole="+s;$.ajax({type:"GET",contentType:"application/json; charset=utf-8",dataType:"text",url:a,success:function(t){dispmemtable($("#newmemform").attr("pid"))}})}function newpjid(){var t=$.ajax({type:"GET",url:"./API/projects.php?maxid",dataType:"text",context:document.body,global:!1,async:!1,success:function(t){return t}}).responseText;return parseInt(t)+1}$(document).ready((function(){"0"==$(".totalpjs").html()?$("#init").show():$("#init").hide(),$.ajax({type:"GET",url:"./API/projects.php?maxid",dataType:"text",success:function(t){t=parseInt(t)+1,$("#lastidval").val(t),$("#lastidval").text(t)}})}));var pmc=0;function addproject(t,e,s,n,a,d,o,i){var l="./API/store_pj.php?&title="+t+"&goal="+e+"&descr="+s+"&sdate="+n+"&edate="+a+",&owner="+d+"&status="+o+"&mc="+i;$.ajax({type:"GET",contentType:"application/json; charset=utf-8",dataType:"text",url:l,success:function(t){}})}function dispmemtable(t){dispmembers=`<tr pid = "${t}" id="newmemform">\n                <th scope="row">0000000</th> \n                <td contenteditable="plaintext-only" id="newmemberfn">First Name</td>\n                <td contenteditable="plaintext-only" id="newmemberln">Last Name</td>\n                <td contenteditable="plaintext-only" id="newmemberrl">ds</td>\n                <td>\n                <button class="btn btn-sm btn-outline-success" id="confirmAddmember" pid="${t}">\n                <i class="fa-solid fa-check-double"></i>\n                </button>\n                <button class="btn btn-sm btn-outline-danger" id="cancelAddmember">\n                <i class="fa-solid fa-xmark"></i>\n                </button>\n\n                </td>\n            </tr>`,$("#disp_members").html(dispmembers),$("#newmemform").hide(),$.ajax({type:"GET",url:"./API/list_mem_this.php?pid="+t,dataType:"json",success:function(t){$.each(t,(function(t,e){row=`<tr>\n                            <th scope="row">${e.id}</th> \n                            <td contenteditable="false" id="fn${e.id}">${e.firstname}</td>\n                            <td contenteditable="false" id="ln${e.id}">${e.lastname}</td>\n                            <td contenteditable="false" id="mr${e.id}">${e.mrole}</td>\n                            <td>\n                            <button class="btn btn-sm btn-outline-danger border-0" onclick="deletemember(${e.id},${e.project_id})">\n                            <i class="fa-solid fa-trash"></i>\n                            </button>\n\n                            <button class="editbtn_${e.id} btn btn-sm btn-outline-secondary border-0" onclick="editmember(${e.id})">\n                            <i class="fa-solid fa-square-pen"></i>\n                            </button>\n\n                            <button class="savebtn_${e.id} btn btn-sm btn-outline-success border-0 d-none" onclick="save_edited_member(${e.id})">\n                            <i class="fa-solid fa-check-double"></i>\n                            </button>\n                            </td>\n                        </tr>`,$("#disp_members").prepend(row)}))}})}function viewpj(t){$("#editmodalfooter").html(""),modalfooter=`\n<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n<button type="button" class="btn btn-iws-green" onclick="saveeditedpj(${t})">Save changes</button>`,$("#editmodalfooter").append(modalfooter),console.log("view : "+t),$("#disp_id").html("Project "+t),$("#disp_pid").val(t),$("#disp_title").val(""),$("#disp_goal").val(""),$("#disp_desc").val(""),$("#disp_sdate").val(""),$("#disp_edate").val(""),$("#disp_owner").val(""),$("#disp_status").val(""),$("#disp_members").html(""),$.ajax({type:"GET",url:"./API/projects.php?pid="+t,dataType:"json",success:function(t){data=t[0],$("#disp_id").html("Project "+data.id),$("#disp_title").val(data.title),$("#disp_goal").val(data.goal),$("#disp_desc").val(data.descr),$("#disp_sdate").val(data.sdate),$("#disp_edate").val(data.edate),$("#disp_owner").val(data.powner),$("#disp_status").val(data.pstatus)}}),dispmemtable(t),$("#displaypjmodal").modal("show")}function togglebtn(t){$(t).hasClass("d-none")?$(t).removeClass("d-none"):$(t).addClass("d-none")}function editmember(t){$("#fn"+t).attr("contenteditable","plaintext-only"),$("#fn"+t).focus(),$("#ln"+t).attr("contenteditable","plaintext-only"),$("#mr"+t).attr("contenteditable","plaintext-only"),togglebtn(".editbtn_"+t),togglebtn(".savebtn_"+t)}function save_edited_member(t){togglebtn(".savebtn_"+t),togglebtn(".editbtn_"+t);var e=$("#fn"+t).text(),s=$("#ln"+t).text(),n=$("#mr"+t).text();"ds"==n||"sm"==n||"po"==n||(n="ds"),$("#fn"+t).attr("contenteditable",!1),$("#ln"+t).attr("contenteditable",!1),$("#mr"+t).attr("contenteditable",!1),console.log("member edited to :"+e+" "+s+" "+n),$.ajax({type:"GET",url:"./API/edit_pj_member.php?mid="+t+"&mfn="+e+"&mln="+s+"&mmr="+n,dataType:"text",success:function(t){}})}function editproject(t,e,s,n,a,d,o,i,l){var p="./API/edit_pj.php?pid="+t+"&title="+e+"&goal="+s+"&descr="+n+"&sdate="+a+"&edate="+d+",&owner="+o+"&status="+i;$.ajax({type:"GET",contentType:"application/json; charset=utf-8",dataType:"text",url:p,success:function(t){}})}function saveeditedpj(e){t=$("#disp_title").val(),g=$("#disp_goal").val(),d=$("#disp_desc").val(),sd=$("#disp_sdate").val(),ed=$("#disp_edate").val(),o=$("#disp_owner").val(),st=$("#disp_status").val(),editproject(e,t,g,d,sd,ed,o,st),lsprojects()}function deletemember(t,e){console.log("member "+t+" has been deleted from "+e),$.ajax({type:"GET",url:"./API/delete_pj_member.php?mid="+t+"&pid="+e,dataType:"text",success:function(t){dispmemtable(e)}})}function deletepj(t){$.ajax({type:"GET",url:"./API/delete_pj.php?pid="+t,dataType:"text",success:function(t){$("#DelToastbody").text("Project Deleted"),$("#liveToast").toast("show"),lsprojects()}})}function calldeletepj(t){$("#confirmDelModal").modal("show"),$("#projecttobedeleted").val(t),$("#confirmdelcode").val(""),$("#tconfirmdelcode").text("delete"+t),$(".modal-title").text("Delete Project "+t+" ?")}function list_sprints(t){$("#SprintsTableBody").html(""),$(".wonpjtitle").html("Project "+t),$.ajax({type:"GET",url:"./API/list_sprints.php?pid="+t,dataType:"json",success:function(e){$.each(e,(function(e,s){var n={1:"Not Started",2:"On Track",3:"Done"},a={1:"iws-not",2:"iws-ont",3:"iws-don"};row=`<tr>\n                <th scope="row" class="fw-normal text-muted text-uppercase">p${t}sp${s.id}</th>\n                <td>${s.title}</td>\n                <td>${s.goal}</td>\n                <td class="fw-bold text-${a[s.spstatus]}">${n[s.spstatus]}</td>\n                <td>${s.sdate}</td>\n                <td>${s.edate}</td>\n                <td>${s.dur} Days</td>\n                <td>\n                <button class="btn border-0 btn-sm btn-outline-secondary" id="loadspbacklog" project-id="${t}" sprint-id="${[s.id]}">\n                <i class="fa-solid fa-table-list"></i> Backlog\n                </button>\n                <button class="btn btn-sm btn-outline-secondary border-0" id="editspbtn" project-id="${t}" sprint-id="${[s.id]}">\n                <i class="fa-solid fa-pencil"></i> Edit\n                </button>\n                </td>\n                </tr>`,$("#SprintsTableBody").append(row)}))}})}function getLastSpEndDate(){if(sprintCount=$("#SprintsTableBody").children().length,spr=$("#SprintsTableBody").children().eq(-1),lasttr=$(spr[0]).children().eq(-3),0==sprintCount){currpj=$("#currpjid").val();var t=$.ajax({type:"GET",url:"./API/projects.php?pid="+currpj,data:"data",dataType:"text",context:document.body,global:!1,async:!1,success:function(t){return t}}).responseText;return JSON.parse(t)[0].sdate}return lasttr.text()}function initNewSPMOdal(){currpj=$("#currpjid").val(),$("#allMemList").html(""),$("#selMemList").html(""),$("#sp_sdate").val(getLastSpEndDate()),$("#sp_edate").val(getLastSpEndDate()),$("#sp_title").val(""),$("#sp_goal").val(""),$("#sp_stat").val("1"),$("#sp_desc").val(""),saveNewSpbtn='<button type="button" class="btn btn-sm btn-iws-green" id="savespbtn">Save Sprint</button>',$("#spmodalfooter").html(saveNewSpbtn);var t=$.ajax({type:"GET",url:"./API/list_mem_this.php?pid="+currpj,data:"data",dataType:"text",context:document.body,global:!1,async:!1,success:function(t){return t}}).responseText;$.each(JSON.parse(t),(function(t,e){newli=`<li class="list-group-item" id="${e.id}">${e.firstname} ${e.lastname}</li>`,$("#allMemList").append(newli)}))}function calctimespan(t,e){return moment.duration(moment(e,"YYYY-MM-DD").diff(moment(t,"YYYY-MM-DD"))).asDays()}function initviewsp(t,e){$("#allMemList").html(""),$("#selMemList").html(""),$("#sp_sdate").val(""),$("#sp_edate").val(""),$("#sp_title").val(""),$("#sp_goal").val(""),$("#sp_stat").val("1"),$("#sp_desc").val(""),saveeditbtn=`\n        <button type="button" class="btn btn-sm btn-iws-red" id="CallToDeleteSP" project-id="${e}" sprint-id="${t}"><i class="fa-solid fa-trash"></i> Delete Sprint</button>\n        <button type="button" class="btn btn-sm btn-iws-green" project-id="${e}" sprint-id="${t}" id="saveEditedSprint">Save Changes</button>`,$("#spaemodal_title").html("Sprint "+t),$("#spmodalfooter").html(saveeditbtn),$.ajax({type:"GET",url:"./API/list_sprints.php?pid="+e+"&sid="+t,dataType:"json",success:function(e){$("#sp_title").val(e[0].title),$("#spaemodal_title").html("Sprint "+t+`<span class="text-muted"> : ${e[0].title}</span>`),$("#sp_goal").val(e[0].goal),$("#sp_sdate").val(e[0].sdate),$("#sp_edate").val(e[0].edate),$("#sp_dur").val(e[0].dur),$("#sp_stat").val(e[0].spstatus),$("#sp_desc").val(e[0].descr)}})}function editsprint(t,e,s,n,a,d,o,i,l){var p="./API/edit_sp.php?pid="+e+"&sid="+t+"&title="+s+"&goal="+n+"&descr="+l+"&sdate="+a+"&edate="+d+"&status="+i+"&lasts="+o;$.ajax({type:"GET",contentType:"application/json; charset=utf-8",dataType:"text",url:p,success:function(t){list_sprints(e),$("#sprintmodal").modal("hide")}})}function saveeditedsprint(e,s){t=$("#sp_title").val(),g=$("#sp_goal").val(),sd=$("#sp_sdate").val(),ed=$("#sp_edate").val(),dur=$("#sp_dur").val(),st=$("#sp_stat").val(),des=$("#sp_desc").val(),editsprint(e,s,t,g,sd,ed,dur,st,des)}function ShowbacklogArea(t,e){$(".SprintBacklogTitle").html("Sprint "+e+" Backlog"),$("#spbgtable").attr("pid",t),$("#spbgtable").attr("sid",e),$("#panel-workon").hide(),$("#BacklogArea").show(),showonprojecttab(),ListStories()}function ClosebacklogArea(){$(".SprintBacklogTitle").html("Sprint Backlog"),$("#panel-workon").show(),$("#BacklogArea").hide()}$("#Addmember").click((function(){fn=$("#Newm_fname").val(),ln=$("#Newm_lname").val(),role=$("#Newm_role").val(),pid=$(this).attr("pid"),addmember(fn,ln,role,pid),pmc+=1,setmemfields()})),$("#SavePjBtn").click((function(){t=$("#pjtitle").val(),g=$("#pjgoal").val(),d=$("#pjdesc").val(),sd=$("#sdate").val(),ed=$("#edate").val(),o=$("#pjowner").val(),st=$("#pjstatus").val(),addproject(t,g,d,sd,ed,o,st,pmc),setAddpjFields(),setTimeout((()=>{lsprojects()}),50),closeAddPj(),lsprojects()})),$("#listmember").click((function(){list_mem_this(parseInt($("#lastidval").val()))})),$("#testreal").click((function(){lsprojects()})),$("#AddPjBtn").click((function(){Setlastpjid(),x=parseInt($("#lastidval").text()),$("#Addmember").attr("pid",x),showAddPj()})),$("#CancelPjBtn").click((function(){closeAddPj(),pmc=0})),$("#dismemtb").on("click","#addmember",(function(){$("#newmemform").show(),$("#newmemform").focus(),$("#newmemberfn").focus()})),$("#dismemtb").on("click","#cancelAddmember",(function(){$("#newmemform").hide(),dispmemtable($("#newmemform").attr("pid"))})),$("#dismemtb").on("click","#confirmAddmember",(function(){pid=$(this).attr("pid"),fn=$("#newmemberfn").text(),ln=$("#newmemberln").text(),role=$("#newmemberrl").text(),postaddmember(fn,ln,role,pid),$("#newmemform").hide()})),$("#forcedelete").click((function(){var t=$("#projecttobedeleted").val();$("#tconfirmdelcode").text()==$("#confirmdelcode").val()?(console.log("Deleted : "+t),$("#confirmDelModal").modal("hide"),deletepj(t)):console.log("code error")})),pjtspfooter='<tfoot class="table-dark"><td colspan="9" class="text-center"><button class="btn btn-sm btn-success" id="addsprint"><i class="fa-solid fa-plus"></i> Add Sprint</button></td></tfoot>',$("#BtnCloseSPB").click((function(){CloseWorkOn(),$("#pjtspfooter").html(pjtspfooter)})),$("#pjtbody").on("click","#btn-workon-pj",(function(){workingOn=$(this).attr("project-id"),$("#currpjid").val(workingOn),showWorkOn(),$("#pjtspfooter").html(pjtspfooter),$(".wonpjtitle").text("Project "+workingOn),list_sprints(workingOn)})),$("#addsprint").click((function(){initNewSPMOdal(),$("#spaemodal_title").html("New Sprint"),$("#sprintmodal").modal("show")})),$("#sp_sdate").change((function(){$("#sp_dur").val(calctimespan($("#sp_sdate").val(),$("#sp_edate").val()))})),$("#sp_edate").change((function(){$("#sp_dur").val(calctimespan($("#sp_sdate").val(),$("#sp_edate").val()))})),$("#allMem").on("click","li",(function(){li_id=$(this).attr("id"),$("#selMem ul").append('<li class="list-group-item" id='+li_id+">"+$(this).html()+"</li>"),$(this).remove()})),$("#selMem").on("click","li",(function(){li_id=$(this).attr("id"),$("#allMem ul").append('<li class="list-group-item" id='+li_id+">"+$(this).html()+"</li>"),$(this).remove()})),$("#sprintmodal").on("click","#savespbtn",(function(){midr=[],rr=$("#selMemList").children(),$(rr).each((function(t,e){midr.push($(e).attr("id"))})),sp_pid=$("#currpjid").val(),sp_title=$("#sp_title").val(),sp_goal=$("#sp_goal").val(),sp_sdate=$("#sp_sdate").val(),sp_edate=$("#sp_edate").val(),sp_lasts=$("#sp_dur").val(),sp_descr=$("#sp_desc").val(),sp_status=$("#sp_stat").val(),sp_memids=JSON.stringify(midr),$.ajax({type:"GET",url:"./API/store_sp.php?pid="+sp_pid+"&title="+sp_title+"&goal="+sp_goal+"&sdate="+sp_sdate+"&edate="+sp_edate+"&lasts="+sp_lasts+"&descr="+sp_descr+"&members="+sp_memids+"&status="+sp_status,dataType:"text",success:function(t){list_sprints(sp_pid),$("#sprintmodal").modal("hide")}})})),$("#SprintsTable").on("click","#editspbtn",(function(){initviewsp($(this).attr("sprint-id"),$(this).attr("project-id")),$("#sprintmodal").modal("show")})),$("#sprintmodal").on("click","#saveEditedSprint",(function(){saveeditedsprint($(this).attr("sprint-id"),$(this).attr("project-id"))})),$("#panel-workon").on("click","#loadspbacklog",(function(){ShowbacklogArea($(this).attr("project-id"),$(this).attr("sprint-id"))})),$("#BtnBackToSprints").click((function(){ClosebacklogArea(),$("#spbgtable").attr("pid",""),$("#spbgtable").attr("sid","")})),$("#taskcategory").change((function(){"onproject"==$(this).val()?showonprojecttab():"offproject"==$(this).val()&&showoffprojecttab(),$(".offpjtable").attr("pid",$("#spbgtable").attr("pid")),$(".offpjtable").attr("sid",$("#spbgtable").attr("sid")),loadOffTasks()})),lsprojects();